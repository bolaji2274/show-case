name: Deploy to EC2

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci

    - name: Build application
      run: npm run build
      env:
        NODE_ENV: production
        VITE_APP_EMAILJS_SERVICE_ID: ${{ secrets.VITE_APP_EMAILJS_SERVICE_ID }}
        VITE_APP_EMAILJS_TEMPLATE_ID: ${{ secrets.VITE_APP_EMAILJS_TEMPLATE_ID }}
        VITE_APP_EMAILJS_PUBLIC_KEY: ${{ secrets.VITE_APP_EMAILJS_PUBLIC_KEY }}
      
    - name: Create deployment archive
      run: |
        echo "üì¶ Creating deployment archive..."
        tar -czf dist.tar.gz dist/
        ls -lh dist.tar.gz
    
    - name: Upload to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        source: "dist.tar.gz"
        target: "/tmp/"
    
    - name: Deploy on EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        script: |
          set -e  # Exit on any error
          echo "üöÄ Deploying..."
          APP_PATH="${{ secrets.EC2_APP_PATH }}"
          BACKUP_DIR="$APP_PATH/backups"
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)

          # Create backup directory
          mkdir -p "$BACKUP_DIR"
          # Backup current deployment
          if [ -d "$APP_PATH/dist" ]; then
            echo "üì¶ Creating backup..."
            tar -czf "$BACKUP_DIR/dist_backup_$TIMESTAMP.tar.gz" -C "$APP_PATH" dist 2>/dev/null || echo "Backup created with warnings"
             # Keep only last 5 backups
            cd "$BACKUP_DIR"
            ls -t dist_backup_*.tar.gz 2>/dev/null | tail -n +6 | xargs -r rm
            cd "$APP_PATH"
          fi

          # Verify uploaded file
          if [ ! -f "/tmp/dist.tar.gz" ]; then
            echo "‚ùå ERROR: dist.tar.gz not found!"
            exit 1
          fi

          # Remove old deployment completely before extraction
          echo "üóëÔ∏è Removing old deployment..."
          if [ -d "$APP_PATH/dist" ]; then
            # rm -rf "$APP_PATH/dist"
            rm -rf "$APP_PATH/dist" || {
              echo "‚ö†Ô∏è  Could not remove with user permissions, trying sudo..."
              sudo rm -rf "$APP_PATH/dist"
            }
          fi

          # Create dist directory with proper permissions
          mkdir -p "$APP_PATH/dist"
          sudo chown -R $USER:$USER "$APP_PATH/dist"

          # Extract new build with overwrite flag
          echo "üìÇ Extracting new build..."
          cd "$APP_PATH"
          tar -xzf /tmp/dist.tar.gz --overwrite
          rm /tmp/dist.tar.gz

          # Set proper permissions
          echo "üîê Setting permissions..."
          sudo chown -R www-data:www-data dist/
          sudo chmod -R 755 dist/

          # Fix any remaining permission issues
          sudo find dist/ -type f -exec chmod 644 {} \;
          sudo find dist/ -type d -exec chmod 755 {} \;
          
          # Verify critical files exist
          if [ ! -f "dist/index.html" ]; then
            echo "‚ùå ERROR: index.html not found in build!"
            echo "Rolling back..."
            if [ -f "$BACKUP_DIR/dist_backup_$TIMESTAMP.tar.gz" ]; then
              rm -rf dist
              tar -xzf "$BACKUP_DIR/dist_backup_$TIMESTAMP.tar.gz"
            fi
            exit 1
          fi

          # Test Apache
          echo "üß™ Testing Apache..."
          sudo apache2ctl configtest
          
          # Reload Apache
          echo "üîÑ Reloading Apache..."
          sudo systemctl reload apache2
          
          echo "‚úÖ Deployment completed!"
          echo "üì¶ Build size: $(du -sh dist | cut -f1)"
          echo "üìÑ Files: $(find dist -type f | wc -l)"


    - name: Run smoke tests
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        script: |
          echo "üß™ Running tests..."
          
          if [ -f "${{ secrets.EC2_APP_PATH }}/dist/index.html" ]; then
            echo "‚úÖ index.html exists"
          else
            echo "‚ùå index.html missing!"
            exit 1
          fi
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost)
          echo "‚úÖ Site responding (HTTP $HTTP_CODE)"
          
          echo "‚úÖ All tests passed!"
    
    - name: Deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "‚úÖ DEPLOYMENT SUCCESSFUL"
          echo "üåê https://${{ secrets.EC2_HOST }}"
        else
          echo "‚ùå DEPLOYMENT FAILED"
        fi