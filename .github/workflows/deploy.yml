name: Deploy to EC2

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci

    - name: Build application
      run: npm run build
      env:
        NODE_ENV: production
        VITE_APP_EMAILJS_SERVICE_ID: ${{ secrets.VITE_APP_EMAILJS_SERVICE_ID }}
        VITE_APP_EMAILJS_TEMPLATE_ID: ${{ secrets.VITE_APP_EMAILJS_TEMPLATE_ID }}
        VITE_APP_EMAILJS_PUBLIC_KEY: ${{ secrets.VITE_APP_EMAILJS_PUBLIC_KEY }}
      
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        script: |
          set -e
          echo "ğŸš€ Starting deployment..."
          
          APP_PATH="${{ secrets.EC2_APP_PATH }}"
          BACKUP_DIR="$HOME/backups"
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          
          # Create backup directory
          mkdir -p "$BACKUP_DIR"
          
          # Backup current deployment
          if [ -d "$APP_PATH/dist" ]; then
            echo "ğŸ“¦ Creating backup..."
            tar -czf "$BACKUP_DIR/dist_backup_$TIMESTAMP.tar.gz" -C "$APP_PATH" dist || echo "Backup completed"
            
            # Keep only last 5 backups
            cd "$BACKUP_DIR"
            ls -t dist_backup_*.tar.gz 2>/dev/null | tail -n +6 | xargs -r rm
          fi
          
          # Navigate to app directory
          cd "$APP_PATH"
          
          # Pull latest changes
          echo "ğŸ“¥ Pulling latest code..."
          git fetch origin
          git reset --hard origin/main
          
          # Install dependencies
          echo "ğŸ“¦ Installing dependencies..."
          npm ci
          
          # Build the application
          echo "ğŸ—ï¸ Building application..."
          npm run build
          
          # Set permissions (only this needs sudo)
          echo "ğŸ” Setting permissions..."
          sudo chown -R www-data:www-data dist/
          
          # Test Apache
          echo "ğŸ§ª Testing Apache..."
          sudo apache2ctl configtest
          
          # Reload Apache
          echo "ğŸ”„ Reloading Apache..."
          sudo systemctl reload apache2
          
          echo "âœ… Deployment completed!"
          echo "ğŸ“¦ Build size: $(du -sh dist | cut -f1)"
          echo "ğŸ“„ Files: $(find dist -type f | wc -l)"