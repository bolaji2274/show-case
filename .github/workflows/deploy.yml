name: Deploy to EC2

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build application
      run: npm run build
      
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        script: |
          set -e  # Exit on any error
          
          echo "🔍 Starting deployment debug..."
          echo "📍 Current user: $(whoami)"
          echo "📍 Current directory: $(pwd)"
          echo "📍 Home directory: $HOME"
          
          # Set up environment variables
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          
          echo "📍 Node.js path: $(which node || echo 'Node.js not found')"
          echo "📍 NPM path: $(which npm || echo 'NPM not found')"
          
          # Create app directory if it doesn't exist
          echo "📁 Creating/checking directory: /var/www/portfolio2"
          sudo mkdir -p /var/www/portfolio2
          
          # Change ownership to deploy user for git operations
          echo "👤 Setting ownership to deploy user..."
          sudo chown -R deploy:deploy /var/www/portfolio2
          
          echo "📂 Navigating to /var/www/portfolio2"
          cd /var/www/portfolio2
          echo "📍 Current directory: $(pwd)"
          echo "📍 Directory contents:"
          ls -la
          
          # Clone or pull the repository
          if [ -d ".git" ]; then
            echo "🔄 Repository exists, pulling latest changes..."
            git pull origin main
          else
            echo "📥 Cloning repository..."
            git clone https://github.com/bolaji2274/show-case.git .
          fi
          
          echo "📍 After git operation, directory contents:"
          ls -la
          
          # Install dependencies
          echo "📦 Installing dependencies..."
          npm ci --only=production
          
          echo "📍 After npm install, checking package.json:"
          [ -f "package.json" ] && echo "✅ package.json found" || echo "❌ package.json not found"
          
          # Build the application
          echo "🔨 Building application..."
          npm run build
          
          echo "📍 After build, checking dist directory:"
          [ -d "dist" ] && echo "✅ dist directory created" || echo "❌ dist directory not found"
          [ -d "dist" ] && ls -la dist/ || echo "Cannot list dist contents"
          
          # Set proper permissions for Apache
          echo "🔐 Setting permissions for Apache..."
          sudo chown -R www-data:www-data /var/www/portfolio2/dist/
          sudo chmod -R 755 /var/www/portfolio2/dist/
          
          # Test and reload Apache
          echo "🧪 Testing Apache configuration..."
          sudo apache2ctl configtest
          if [ $? -eq 0 ]; then
            echo "🔄 Reloading Apache..."
            sudo systemctl reload apache2
            echo "✅ Apache reloaded successfully!"
          else
            echo "❌ Apache configuration test failed!"
            exit 1
          fi
          
          echo "🎉 Deployment completed successfully!"
          echo "📦 Node.js version: $(node -v)"
          echo "📁 Build directory contents:"
          ls -la /var/www/portfolio2/dist/