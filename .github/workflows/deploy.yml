name: Deploy to EC2

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build application
      run: npm run build
      
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        script: |
          set -e  # Exit on any error
          
          echo "ğŸ” Starting deployment debug..."
          echo "ğŸ“ Current user: $(whoami)"
          echo "ğŸ“ Current directory: $(pwd)"
          echo "ğŸ“ Home directory: $HOME"
          
          # Set up environment variables
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          
          echo "ğŸ“ Node.js path: $(which node || echo 'Node.js not found')"
          echo "ğŸ“ NPM path: $(which npm || echo 'NPM not found')"
          
          # Create app directory if it doesn't exist
          echo "ğŸ“ Creating/checking directory: /var/www/portfolio2"
          sudo mkdir -p /var/www/portfolio2
          
          # Change ownership to deploy user for git operations
          echo "ğŸ‘¤ Setting ownership to deploy user..."
          sudo chown -R deploy:deploy /var/www/portfolio2
          
          echo "ğŸ“‚ Navigating to /var/www/portfolio2"
          cd /var/www/portfolio2
          echo "ğŸ“ Current directory: $(pwd)"
          echo "ğŸ“ Directory contents:"
          ls -la
          
          # Clone or pull the repository
          if [ -d ".git" ]; then
            echo "ğŸ”„ Repository exists, pulling latest changes..."
            git pull origin main
          else
            echo "ğŸ“¥ Cloning repository..."
            git clone https://github.com/bolaji2274/show-case.git .
          fi
          
          echo "ğŸ“ After git operation, directory contents:"
          ls -la
          
          # Install dependencies
          echo "ğŸ“¦ Installing dependencies..."
          npm ci --only=production
          
          echo "ğŸ“ After npm install, checking package.json:"
          [ -f "package.json" ] && echo "âœ… package.json found" || echo "âŒ package.json not found"
          
          # Build the application
          echo "ğŸ”¨ Building application..."
          npm run build
          
          echo "ğŸ“ After build, checking dist directory:"
          [ -d "dist" ] && echo "âœ… dist directory created" || echo "âŒ dist directory not found"
          [ -d "dist" ] && ls -la dist/ || echo "Cannot list dist contents"
          
          # Set proper permissions for Apache
          echo "ğŸ” Setting permissions for Apache..."
          sudo chown -R www-data:www-data /var/www/portfolio2/dist/
          sudo chmod -R 755 /var/www/portfolio2/dist/
          
          # Test and reload Apache
          echo "ğŸ§ª Testing Apache configuration..."
          sudo apache2ctl configtest
          if [ $? -eq 0 ]; then
            echo "ğŸ”„ Reloading Apache..."
            sudo systemctl reload apache2
            echo "âœ… Apache reloaded successfully!"
          else
            echo "âŒ Apache configuration test failed!"
            exit 1
          fi
          
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸ“¦ Node.js version: $(node -v)"
          echo "ğŸ“ Build directory contents:"
          ls -la /var/www/portfolio2/dist/